{% extends 'FrontendBundle::layout.html.twig' %}

{% block stylesheets %}
  {{ parent() }}
  <!-- Calendar -->
  <link rel="stylesheet" href="{{asset('css/fullcalendar.css')}}">
  <!-- Main stylesheet -->
  <link rel="stylesheet" href="{{asset('css/style.css')}}">
  <!-- Widgets stylesheet -->
  <link rel="stylesheet" href="{{asset('css/widgets.css')}}">   
  <!-- Gritter Notifications stylesheet -->
  <link rel="stylesheet" href="{{asset('css/jquery.gritter.css')}}">
  <link rel="stylesheet" href="{{asset('css/main.css')}}">  
{% endblock %}

{% block mainbar %}
    <!-- Main bar -->
    <div class="mainbar">
        <div class="matter">
            <div class="container">

                <div class="row">

                    <div class="col-md-12">

                        <div class="widget">
                            <div class="widget-head">
                                <h2>Calendario - {{recurso.nombre}}</h2>
                                <select id="selectRecurso">
                                    {% for rec in recursos %}
                                        {% if rec.id == recurso.id %}
                                        <option value="{{rec.id}}" selected>{{rec.nombre}}</option>
                                        {% else %}
                                        <option value="{{rec.id}}">{{rec.nombre}}</option>
                                        {% endif %}    
                                    {% endfor %}    
                                </select>
                            </div>
                            <div class="widget-content">
                                <div class="padd">
                                    <!-- calendario -->
                                    <!-- Below line produces calendar. I am using FullCalendar plugin. -->
                                    <div id="calendar"></div>
                                </div>

                            </div>

                        </div>  

                    </div>

                </div>

            </div>
        </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog" aria-labelledby="labelFormulario" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="labelFormulario"></h4>
      </div>
      <div class="modal-body" id="modalBodyFormulario">
          
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="guardar();">Guardar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block javascripts %}
  {{ parent() }}
<script src="{{asset('js/jquery-ui-1.9.2.custom.min.js')}}"></script> <!-- jQuery UI -->
<script src="{{asset('js/jquery-ui-timepicker-addon.js')}}"></script>
<script src="{{asset('js/fullcalendar.min.js')}}"></script> <!-- Full Google Calendar - Calendar -->
<!-- jQuery Notification - Noty -->
<script src="{{asset('js/jquery.noty.js')}}"></script> <!-- jQuery Notify -->
<script src="{{asset('js/themes/default.js')}}"></script> <!-- jQuery Notify -->
<script src="{{asset('js/layouts/bottom.js')}}"></script> <!-- jQuery Notify -->
<script src="{{asset('js/layouts/topRight.js')}}"></script> <!-- jQuery Notify -->
<script src="{{asset('js/layouts/top.js')}}"></script> <!-- jQuery Notify -->
<!-- jQuery Notification ends -->

<script src="{{asset('js/jquery.slimscroll.min.js')}}"></script> <!-- jQuery SlimScroll -->
<script src="{{asset('js/bootbox.min.js')}}"></script> <!-- Filter for support page -->
<script src="{{asset('js/custom.js')}}"></script> <!-- Custom codes -->
<script>
    /* Calendar */
  var calEvent;
  $(document).ready(function() {
   
    var date = new Date();
    var d = date.getDate();
    var m = date.getMonth();
    var y = date.getFullYear();
    
    $('#calendar').fullCalendar({
      header: {
        left: 'prev',
        center: 'title',
        right: 'month,agendaWeek,agendaDay,next'
      },
      editable: true,
      events: [
	{% for reservacion in entities %}
        {
          title: 'Reservacion',
          start: new Date({{reservacion.fechaEvento|date('y')}}, {{reservacion.fechaEvento|date('m')}}, {{reservacion.fechaEvento|date('d')}}, {{reservacion.desde|date('g')}}, {{reservacion.desde|date('i')}},0),
          end: new Date({{reservacion.fechaEvento|date('y')}}, {{reservacion.fechaEvento|date('m')}}, {{reservacion.fechaEvento|date('d')}}, {{reservacion.hasta|date('g')}}, {{reservacion.hasta|date('i')}},0)
        },
        {% endfor %}
      ],
      dayClick: function(date, allDay, jsEvent, view) {
        
        y = date.getFullYear();
        m = date.getMonth();
        d = date.getDate();

        h1 = date.getHours();
        m1 = date.getMinutes();

        h2 = h1 + 1;
        m2 = m1;
        //alert("se dio click en "+ (new Date(y, m, d, h1, m1)));
        calEvent = {
            title: 'New Calendar Event',
            editable: true,
            start: new Date(y, m, d, h1, m1),
            end: new Date(y, m, d, h2, m2),
            allDay: false,
			year: y,
			month: m,
			day: d,
			hora: h1,
			minuto: m1,
			fecha: (y + "-" + (m+1) + "-" + d)
        }
		addReservacion(calEvent);
    }
    });
    
    $("#selectRecurso").on("change",function(e){
       e.preventDefault();
       var valor = $(this).val();
       location.href = '{{path('reservaciones_calendario')}}?recurso='+valor;
    });
    
  });
  function addReservacion(calEvent){
  	  
      mostrarFormulario("Realizar reservacion");
      getFormulario(calEvent.fecha);
  }
  
  function mostrarFormulario(titulo){
      $("#modalFormulario").modal("show");
      $("#labelFormulario").html(titulo);
      $loader = $("<img>");
      $loader.attr({'src': '{{asset('images/bx_loader.gif')}}','id': 'loader'});
      $loader.css({'maxWidth': '80px'});
      $("#modalBodyFormulario").html($loader);
  }
  
  function guardar(){
      var $form = $("#modalBodyFormulario form");
      var data = $form.serialize();
      $.ajax({
          url: $form.attr('action'),
          type: 'POST',
          data: data,
          dataType: 'json',
      }).done(function(data, textStatus,jqXHR){
          debugger;
          data = JSON.parse(data);
          if(data.respuesta == 'nuevo'){
              $("#modalBodyFormulario").html(data.form);
              $("#modalBodyFormulario form").attr({'action': data.rutaAction});
			  activarDateTimePicker();
          }else if(data.respuesta == 'creado'){
              $("#modalFormulario").modal("hide");
    		  location.href='{{path('reservaciones')}}';
          }
      }).fail(function(data){
          console.log(data);
      });
  }
  
  function getFormulario(dia){
          $.ajax({
              url: '{{path('reservaciones_realizar_reservacion')}}',
              type: 'GET',
              dataType: 'json',
              data: {'fecha':dia},
          }).done(function(data, textStatus,jqXHR){
              data = JSON.parse(data);
              if(data.respuesta == 'nuevo'){
                  $("#modalBodyFormulario").html(data.form);
                  $("#modalBodyFormulario form").attr({'action': data.rutaAction});
				  activarDateTimePicker();
              }
          }).fail(function(data){
		  		alert("Error");
		  		console.log(data);
		  });
  }
  function activarDateTimePicker(){
            $("#richpolis_frontendbundle_reservacion_fechaEvento").datepicker({
                dateFormat: "yy-mm-dd",
                {% if is_granted('ROLE_SUPER_ADMIN') == false %}    
                minDate: 0,       
                maxDate: "+3M"
                {% endif %}
            });
            
            $('#richpolis_frontendbundle_reservacion_desde').timepicker({
                    timeFormat: 'HH:mm',
                    stepHour: 1,
                    stepMinute: 15,
                    controlType: 'select',
            });
            
            $('#richpolis_frontendbundle_reservacion_hasta').timepicker({
                    timeFormat: 'HH:mm',
                    stepHour: 1,
                    stepMinute: 15,
                    controlType: 'select',
            });
  }
</script>

{% endblock %}

