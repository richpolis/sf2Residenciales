{% extends 'FrontendBundle::layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <!-- Uniform -->
    <link rel="stylesheet" href="{{asset('css/uniform.default.html')}}"> 
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="{{asset('css/style.css')}}">
    <!-- Widgets stylesheet -->
    <link rel="stylesheet" href="{{asset('css/widgets.css')}}">   
    <!-- Gritter Notifications stylesheet -->
    <link rel="stylesheet" href="{{asset('css/jquery.gritter.css')}}"> 
    <!-- Admin stylesheet -->
    <link rel="stylesheet" href="{{asset('css/admin.css')}}">
    <!-- Admin stylesheet -->
    <link rel="stylesheet" href="{{asset('css/main.css')}}">
{% endblock %}

{% block mainbar %}
    <!-- Main bar -->
    <div class="mainbar">
        <!-- Matter -->
        <div class="matter">
            <div class="container">
                <div class="row">
                    {# foros #}
                    {{render(controller('FrontendBundle:Default:forosIndex'))}}

                    {# cargos y pagos #}
                    <div class="col-md-6">
                        <!-- Widget -->
                        <div class="widget">
                            <div style="background-color: #DC322F; color: white; text-align: center;font-size: 20px; padding: 10px;">    
                                Estado de cuenta    
                            </div>
                            <div class="widget-content">
                                <!-- Widget content -->
                                <div class="padd">
                                    <table class="table table-striped table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th colspan="6">Cargos pendientes de pago</th>
                                            </tr>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Cargo</th>
                                                <th>Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set monto = 0 %}
                                            {% for entity in cargos %}
                                                <tr>
                                                    <td>{{ entity.createdAt|date('d-m-Y') }}</td>
                                                    <td>
                                                        <div class="tipo-cargo">{{ entity.stringTipoCargo }}</div>
                                                        <div class="descripcion-cargo">{{ entity.cargo }}</div>
                                                    </td>
                                                    <td>$ {{ entity.monto | number_format(2,".",",") }}</td>
                                                </tr>

                                                {% set monto = monto + entity.monto %}
                                            {% endfor %}
                                        <tfoot>
                                            <tr>
                                                <th colspan="6">
                                                    {% if monto > 0 %}
                                                        Total al pagar $ {{monto|number_format(2,".",",")}}
                                                    {% else %}
                                                        Sin saldo pendiente
                                                    {% endif %}
                                                    <a href="{{path('estadodecuentas_recibo',{'_format':'pdf'})}}" class="btn btn-info pull-right" target="_blank">Recibo</a>
                                                </th>
                                            </tr>
                                        </tfoot>
                                        </tbody>
                                    </table>
                                </div>
                            </div>  
                        </div>
                    </div>
                                                
                    {# reservaciones #}
                    {{render(controller('FrontendBundle:Default:reservacionesIndex'))}}
                    
                    {# avisos y notificaciones #}
                    <div class="col-md-6 portlets ui-sortable">
                        <div class="widget">    
                            <div style="background-color: #1392e9; color: white; text-align: center;font-size: 20px; padding: 10px;">    
                                Avisos y notificaciones    
                            </div>
                            <div class="widget-content">
                                <div class="padd">
                                    {{render(controller('FrontendBundle:Default:avisosIndex'))}}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
    <!-- Mainbar ends -->        
    <div class="clearfix"></div>
    <!-- Modal -->
    <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog" aria-labelledby="labelFormulario" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="labelFormulario"></h4>
          </div>
          <div class="modal-body" id="modalBodyFormulario">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="guardar();">Guardar</button>
          </div>
        </div>
      </div>
    </div> 
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="{{asset('js/jquery-ui-1.9.2.custom.min.js')}}"></script> <!-- jQuery UI -->
    <script src="{{asset('js/fullcalendar.min.js')}}"></script> <!-- Full Google Calendar - Calendar -->
    <script src="{{asset('js/jquery.rateit.min.js')}}"></script> <!-- RateIt - Star rating -->
    <script src="{{asset('js/jquery.prettyPhoto.js')}}"></script> <!-- prettyPhoto -->

    <!-- jQuery Flot -->
    <script src="{{asset('js/excanvas.min.js')}}"></script>
    <script src="{{asset('js/jquery.flot.js')}}"></script>
    <script src="{{asset('js/jquery.flot.resize.js')}}"></script>
    <script src="{{asset('js/jquery.flot.pie.js')}}"></script>
    <script src="{{asset('js/jquery.flot.stack.js')}}"></script>

    <!-- jQuery Notification - Noty -->
    <script src="{{asset('js/jquery.noty.js')}}"></script> <!-- jQuery Notify -->
    <script src="{{asset('js/themes/default.js')}}"></script> <!-- jQuery Notify -->
    <script src="{{asset('js/layouts/bottom.js')}}"></script> <!-- jQuery Notify -->
    <script src="{{asset('js/layouts/topRight.js')}}"></script> <!-- jQuery Notify -->
    <script src="{{asset('js/layouts/top.js')}}"></script> <!-- jQuery Notify -->
    <!-- jQuery Notification ends -->

    <script src="{{asset('js/datatables/js/jquery.dataTables.js')}}"></script>

    <script src="{{asset('js/sparklines.js')}}"></script> <!-- Sparklines -->
    <script src="{{asset('js/jquery.cleditor.min.js')}}"></script> <!-- CLEditor -->
    <script src="{{asset('js/bootstrap-datetimepicker.min.js')}}"></script> <!-- Date picker -->
    <script src="{{asset('js/jquery.uniform.min.html')}}"></script> <!-- jQuery Uniform -->
    <script src="{{asset('js/jquery.slimscroll.min.js')}}"></script> <!-- jQuery SlimScroll -->
    <script src="{{asset('js/bootstrap-switch.min.js')}}"></script> <!-- Bootstrap Toggle -->
    <script src="{{asset('js/filter.js')}}"></script> <!-- Filter for support page -->
    <script src="{{asset('js/custom.js')}}"></script> <!-- Custom codes -->
    <script src="{{asset('js/sfrichpolis.js')}}"></script>
    <script src="{{asset('js/jquery.formdata.serialize.js')}}"></script> <!-- Custom codes -->
    <script>
    var reservacionActual = 0;
    $(document).ready(function(){
       $("#crearReservacion").on("click",function(){
           location.href = '{{path('reservaciones_calendario_select_recurso')}}';
       }); 
    });
    function addPago(reservacion){
        mostrarFormulario("Realizar pago");
        reservacionActual = reservacion;
        getFormulario();
    }
    
    function mostrarFormulario(titulo){
        $("#modalFormulario").modal("show");
        $("#labelFormulario").html(titulo);
        $loader = $("<img>");
        $loader.attr({'src': '{{asset('images/bx_loader.gif')}}','id': 'loader'});
        $loader.css({'maxWidth': '80px'});
        $("#modalBodyFormulario").html($loader);
    }
    
    function guardar(){
        debugger;
        var $form = $("#modalBodyFormulario form");
        var data = $form.serializefiles();
        $.ajax({
            url: $form.attr('action')+"?reservacion="+reservacionActual,
            type: 'POST',
            data: data,
            dataType: 'json',
            cache: false,
		contentType: false,
		processData: false,
        }).done(function(data, textStatus,jqXHR){
            debugger;
            data = JSON.parse(data);
            if(data.respuesta == 'nuevo'){
                $("#modalBodyFormulario").html(data.form);
                $("#modalBodyFormulario form").attr({'action': data.rutaAction});
            }else if(data.respuesta == 'creado'){
                $("#modalFormulario").modal("hide");
                $("#reservacion-"+reservacionActual).html($(data.html).find('li').html());
            }
        }).fail(function(data){
            alert("Error");
            console.log(data);
        });
    }
    
    function getFormulario(){
        debugger;
        $.ajax({
            url: '{{path('pagos_realizar_pago_reservacion')}}',
            type: 'GET',
            data: {'reservacion': reservacionActual },
            dataType: 'json',
        }).done(function(data, textStatus,jqXHR){
            data = JSON.parse(data);
            if(data.respuesta == 'nuevo'){
                $("#modalBodyFormulario").html(data.form);
                $("#modalBodyFormulario form").attr({'action': data.rutaAction});
            }
        }).fail(function(data){
            alert("Error");
            console.log(data);
        });;
    }
</script>
{% endblock %}